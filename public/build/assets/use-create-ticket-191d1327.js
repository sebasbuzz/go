import{cS as K,cT as I,cU as $,cV as H,cW as z,O as U,ak as q,v as D,r as o,bh as V,j as s,s as R,a5 as S,t as A,c as k,B as N,T as u,y as Y,F as G,G as W,b1 as X,aY as J,cX as O,Q as Z,au as ee,u as te,D as se,f as ae,ae as re,N as ie,z as ne,E as ce,al as B,a3 as oe,a4 as ue,a6 as de,m as le,av as fe}from"./main-030e7994.js";import{k as me,y as he,C as xe}from"./reply-editor-14b4a609.js";var ge=class extends K{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:I()},t)}getOptimisticResult(e){return e.behavior=I(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var y,h,x,m;const{state:a}=e,r=super.createResult(e,t),{isFetching:i,isRefetching:n}=r,l=i&&((h=(y=a.fetchMeta)==null?void 0:y.fetchMore)==null?void 0:h.direction)==="forward",c=i&&((m=(x=a.fetchMeta)==null?void 0:x.fetchMore)==null?void 0:m.direction)==="backward";return{...r,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:$(t,a.data),hasPreviousPage:H(t,a.data),isFetchingNextPage:l,isFetchingPreviousPage:c,isRefetching:n&&!l&&!c}}};function pe(e,t){return z(e,ge,t)}function Ae(e){return U({queryKey:["tickets",e],queryFn:()=>ye(e),placeholderData:q})}function ye(e){return D.get("tickets",{params:e}).then(t=>t.data)}function ve({user:e,...t}){var r;const{auth:a}=o.useContext(V);return s.jsx(me,{...t,label:e==null?void 0:e.display_name,src:e==null?void 0:e.avatar,link:(e==null?void 0:e.id)&&((r=a.getUserProfileLink)==null?void 0:r.call(a,e))})}function Be(){return R({mutationFn:e=>je(e),onSuccess:async()=>{S.invalidateQueries({queryKey:["mailbox","sidenav-tags"]}),await S.invalidateQueries({queryKey:["tickets"]})},onError:e=>A(e)})}function je(e){return D.post("tickets/status/change",e).then(t=>t.data)}function Le({query:{isInitialLoading:e,fetchNextPage:t,isFetchingNextPage:a,hasNextPage:r},children:i,loaderMarginTop:n="mt-24",style:l,className:c,variant:y="infiniteScroll",loadMoreExtraContent:h,size:x="md"}){const m=o.useRef(null),j=a||e,[p,w]=o.useState(0),d=y==="loadMore"&&p<3?"loadMore":"infiniteScroll";o.useEffect(()=>{const g=m.current;if(!g||d==="loadMore")return;const b=new IntersectionObserver(([P])=>{P.isIntersecting&&r&&!j&&t()});return b.observe(g),()=>{b.unobserve(g)}},[t,r,j,d]);let v;return i?v=a?i:null:d==="loadMore"?v=!e&&r&&s.jsxs("div",{className:k("flex items-center gap-8",n),children:[h,s.jsx(N,{size:x==="md"?"sm":"xs",className:k(x==="sm"?"min-h-24 min-w-96":"min-h-36 min-w-112"),variant:"outline",color:"primary",onClick:()=>{t(),w(p+1)},disabled:j,children:p>=2&&!a?s.jsx(u,{message:"Load all"}):s.jsx(u,{message:"Show more"})})]}):v=s.jsx(Y,{children:a&&s.jsx(G.div,{className:k("flex justify-center w-full",n),...W,children:s.jsx(X,{size:x,isIndeterminate:!0,"aria-label":"loading"})})}),s.jsxs("div",{style:l,className:k("w-full",c,r&&"min-h-36"),role:"presentation",children:[s.jsx("div",{ref:m,"aria-hidden":!0}),v]})}const Q={isDirty:!1,isSaving:!1,body:void 0,attachments:[]},L=J()(e=>({editorIsOpen:!1,setEditorIsOpen:t=>e(a=>({editorIsOpen:t})),ticketIsSaving:!1,setTicketIsSaving:t=>e(a=>({ticketIsSaving:t})),activeDraft:Q,updateActiveDraft:t=>e(a=>{var i;const r=!ke(t.body)||!!((i=t.attachments)!=null&&i.length);return{activeDraft:{...a.activeDraft,isDirty:r,...t}}}),discardActiveDraft:()=>e(()=>({activeDraft:Q}))}));function _(){return L.getState()}function ke(e){return e?e.trim()==="<p></p>"||!e.trim():!0}function De({queryKey:e,defaultOrderDir:t,defaultOrderBy:a,queryParams:r},i,n=""){return i.orderBy||(i.orderBy=a),i.orderDir||(i.orderDir=t),[...e,i,n,r]}function be(e){var P,E,M,F;const{initialPage:t,endpoint:a,defaultOrderBy:r,defaultOrderDir:i,queryParams:n,paginate:l,transformResponse:c,willSortOrFilter:y=!1}=e,[h,x]=o.useState(""),[m,j]=o.useState({orderBy:r,orderDir:i}),p=De(e,m,h),w=o.useRef(O(p)).current,d=pe({placeholderData:y?q:void 0,queryKey:p,queryFn:({pageParam:f,signal:C})=>{const T={...n,perPage:(t==null?void 0:t.per_page)||(n==null?void 0:n.perPage),query:h,paginate:l,...m};return l==="cursor"?T.cursor=f:T.page=f||1,Pe(a,T,c,C)},initialPageParam:l==="cursor"?"":1,getNextPageParam:f=>he(f.pagination)?"next_cursor"in f.pagination?f.pagination.next_cursor:f.pagination.current_page+1:null,initialData:()=>{if(!(!t||O(p)!==w))return{pageParams:[void 0,1],pages:[{pagination:t}]}}}),v=o.useMemo(()=>{var f;return((f=d.data)==null?void 0:f.pages.flatMap(C=>C.pagination.data))||[]},[(P=d.data)==null?void 0:P.pages]),g=(E=d.data)==null?void 0:E.pages[0].pagination,b=g&&"total"in g&&g.total?g.total:null;return{...d,items:v,totalItems:b,noResults:((F=(M=d.data)==null?void 0:M.pages)==null?void 0:F[0].pagination.data.length)===0,isReloading:d.isFetching&&!d.isFetchingNextPage&&d.isPlaceholderData,sortDescriptor:m,setSortDescriptor:j,searchQuery:h,setSearchQuery:x}}async function Pe(e,t,a,r){return t.query&&await new Promise(i=>setTimeout(i,300)),D.get(e,{params:t,signal:t.query?r:void 0}).then(i=>a?a(i.data):i.data)}function Ke(e,t){return be({queryKey:["tickets",`${e}`,"replies"],endpoint:`tickets/${e}/replies`,initialPage:t})}function Se(e,{absolute:t,tab:a}={}){a||(a="tickets");let r=`/agent/users/${e}/${a}`;return t&&(r=`${Z().settings.base_url}${r}`),r}function Ne(){const{data:e}=ee();return o.useCallback(()=>{e&&(e.draft&&_().updateActiveDraft({...e.draft,isDirty:!1}),_().setEditorIsOpen(!0))},[e])}function we({clearTicketCache:e=!0}={}){const{ticketId:t}=te(),{updateActiveDraft:a,discardActiveDraft:r}=L();return R({mutationFn:i=>(a({isSaving:!0}),Ce(i)),onSuccess:async()=>{r(),e&&await S.invalidateQueries({queryKey:["tickets",`${t}`]})},onError:i=>A(i),onSettled:()=>a({isSaving:!1})})}function Ce(e){return D.delete(`replies/${e.id}`).then(t=>t.data)}function Te({draft:e}){const t=Ne();return s.jsxs(o.Fragment,{children:[s.jsx(N,{variant:"outline",size:"2xs",className:"ml-14",onClick:()=>t(),children:s.jsx(u,{message:"Edit"})}),s.jsx(Re,{draft:e})]})}function Re({draft:e}){return s.jsxs(se,{type:"modal",children:[s.jsx(N,{variant:"outline",size:"2xs",className:"ml-6",children:s.jsx(u,{message:"Discard"})}),s.jsx(Ee,{draft:e})]})}function Ee({draft:e}){const t=we(),{close:a}=ae();return s.jsx(re,{isDanger:!0,title:s.jsx(u,{message:"Discard draft"}),body:s.jsx(u,{message:"Are you sure you want to discard this draft?"}),confirm:s.jsx(u,{message:"Discard"}),onConfirm:()=>t.mutate({id:e.id},{onSuccess:a}),isLoading:t.isPending})}const Me={month:"short",day:"numeric",hour:"numeric",minute:"numeric"};function $e({reply:e,isInitial:t,actions:a,attachments:r,className:i}){const n=o.useRef(null);return o.useEffect(()=>{n.current&&ie(n.current)},[]),s.jsxs("div",{className:k("flex items-start gap-20 border-x-2 border-t border-x-transparent py-24",e.type==="drafts"&&"border-l-primary",e.type==="notes"&&"border-l-warning bg-warning/6",i),children:[e.user&&s.jsx(ne,{to:Se(e.user.id),className:"flex-shrink-0 max-md:hidden",target:"_blank",children:s.jsx(ve,{user:e.user,size:"w-50 h-50",circle:!0})}),s.jsxs("div",{className:"min-w-0 flex-auto",children:[s.jsx(Fe,{reply:e,isInitial:t,actions:a}),s.jsx("div",{ref:n,className:"ticket-reply-body mr-24 text-sm",dangerouslySetInnerHTML:{__html:e.body}}),r]})]})}function Fe({reply:e,isInitial:t,actions:a}){var i,n;const{user:r}=ce();return s.jsxs("div",{className:"mb-14 flex items-center",children:[s.jsx("div",{className:"font-medium",children:((i=e.user)==null?void 0:i.id)===(r==null?void 0:r.id)?s.jsx(u,{message:"You"}):(n=e.user)==null?void 0:n.display_name}),s.jsx("div",{className:"ml-4",children:s.jsx(Ie,{reply:e,isInitial:t})}),s.jsx("div",{className:"ml-auto mr-4 flex-shrink-0 text-xs text-muted",children:s.jsx(B,{date:e.created_at,options:Me})}),a]})}function Ie({reply:e,isInitial:t}){switch(e.type){case"drafts":return s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"text-primary",children:s.jsx(u,{message:"created a draft"})}),s.jsx(Te,{draft:e})]});case"notes":return s.jsx("span",{className:"text-warning",children:s.jsx(u,{message:"left a note"})});case"replies":return t?s.jsx("span",{className:"text-muted max-md:hidden",children:s.jsx(u,{message:"started the conversaion"})}):s.jsx("span",{className:"text-muted",children:s.jsx(u,{message:"replied"})})}}const Oe={month:"short",day:"numeric"};function He({ticket:e,actions:t,children:a}){return s.jsx(o.Fragment,{children:s.jsxs("div",{className:"flex items-start gap-12 px-20 py-14 max-md:flex-col md:items-center",children:[s.jsx("h1",{className:"text-2xl",children:e.subject}),a,s.jsx("div",{className:"mr-24 max-md:hidden"}),s.jsxs("div",{className:"whitespace-nowrap text-muted md:ml-auto",children:[s.jsx(oe,{date:e.created_at})," (",s.jsx(B,{date:e.created_at,options:Oe}),")"]}),t]})})}function ze({ticket:e,onRemoveTag:t,tagType:a,size:r="xs",...i}){var n,l;return(n=e.tags)!=null&&n.length?s.jsx(xe,{...i,size:r,selectable:!!t,children:(l=e.tags)==null?void 0:l.filter(c=>c.type!=="status"&&(!a||c.type===a)).map(c=>s.jsx(ue,{onRemove:t?()=>t(c):void 0,children:c.display_name},c.id))}):null}function Ue({isLoading:e,onSubmit:t}){return s.jsx(N,{variant:"flat",color:"primary",radius:"rounded-none",disabled:e,onClick:()=>t==null?void 0:t(),children:s.jsx(u,{message:"Send reply"})})}function Ve(e){return R({mutationFn:t=>Qe(t),onSuccess:async()=>{await S.invalidateQueries({queryKey:["tickets"]}),de(le("Ticket created"))},onError:t=>fe(t,e)})}function Qe(e){return D.post("tickets",e).then(t=>t.data)}export{Le as I,Ue as S,$e as T,ve as U,Ae as a,L as b,Ke as c,Ne as d,He as e,ze as f,be as g,Se as h,we as i,Q as j,Ve as k,Oe as l,_ as t,Be as u};
//# sourceMappingURL=use-create-ticket-191d1327.js.map
