import{d1 as B,d2 as I,d3 as K,d4 as L,d5 as $,d6 as z,j as s,r as d,bs as H,f as T,a1 as P,s as F,h as S,c as k,i as w,T as o,m as U,p as V,q as Y,bc as G,b6 as J,d7 as O,as as W,d8 as X,z as Z,aE as ee,u as te,ab as se,ad as ae,aj as re,x as ie,n as ne,o as oe,au as ce,a2 as ue,a3 as de,aF as le}from"./main-e7ef070d.js";import{j as fe}from"./reply-editor-41efed28.js";var me=class extends B{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:I()},t)}getOptimisticResult(e){return e.behavior=I(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var y,m,h,f;const{state:a}=e,r=super.createResult(e,t),{isFetching:i,isRefetching:n}=r,c=i&&((m=(y=a.fetchMeta)==null?void 0:y.fetchMore)==null?void 0:m.direction)==="forward",p=i&&((f=(h=a.fetchMeta)==null?void 0:h.fetchMore)==null?void 0:f.direction)==="backward";return{...r,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:K(t,a.data),hasPreviousPage:L(t,a.data),isFetchingNextPage:c,isFetchingPreviousPage:p,isRefetching:n&&!c&&!p}}};function he(e,t){return $(e,me,t)}const ge="relative flex flex-shrink-0 items-center justify-center gap-10 overflow-hidden whitespace-nowrap outline-none after:pointer-events-none rounded-full bg-chip text-main pl-8 h-20 text-xs font-medium hover:after:bg-black/5 focus:after:bg-black/10";function Oe({ticketRequestType:e}){var a;const t=z(e);return s.jsx(s.Fragment,{children:t&&t.data&&s.jsx("div",{className:ge,children:(a=t.data.ticket_request_type)==null?void 0:a.display_name})})}function xe({user:e,...t}){var r;const{auth:a}=d.useContext(H);return s.jsx(fe,{...t,label:e==null?void 0:e.display_name,src:e==null?void 0:e.avatar,link:(e==null?void 0:e.id)&&((r=a.getUserProfileLink)==null?void 0:r.call(a,e))})}function Qe(){return T({mutationFn:e=>pe(e),onSuccess:async()=>{P.invalidateQueries({queryKey:["mailbox","sidenav-tags"]}),await P.invalidateQueries({queryKey:["tickets"]})},onError:e=>F(e)})}function pe(e){return S.post("tickets/status/change",e).then(t=>t.data)}function _e({query:{isInitialLoading:e,fetchNextPage:t,isFetchingNextPage:a,hasNextPage:r},children:i,loaderMarginTop:n="mt-24",style:c,className:p,variant:y="infiniteScroll",loadMoreExtraContent:m,size:h="md"}){const f=d.useRef(null),j=a||e,[x,N]=d.useState(0),u=y==="loadMore"&&x<3?"loadMore":"infiniteScroll";d.useEffect(()=>{const g=f.current;if(!g||u==="loadMore")return;const D=new IntersectionObserver(([b])=>{b.isIntersecting&&r&&!j&&t()});return D.observe(g),()=>{D.unobserve(g)}},[t,r,j,u]);let v;return i?v=a?i:null:u==="loadMore"?v=!e&&r&&s.jsxs("div",{className:k("flex items-center gap-8",n),children:[m,s.jsx(w,{size:h==="md"?"sm":"xs",className:k(h==="sm"?"min-h-24 min-w-96":"min-h-36 min-w-112"),variant:"outline",color:"primary",onClick:()=>{t(),N(x+1)},disabled:j,children:x>=2&&!a?s.jsx(o,{message:"Load all"}):s.jsx(o,{message:"Show more"})})]}):v=s.jsx(U,{children:a&&s.jsx(V.div,{className:k("flex justify-center w-full",n),...Y,children:s.jsx(G,{size:h,isIndeterminate:!0,"aria-label":"loading"})})}),s.jsxs("div",{style:c,className:k("w-full",p,r&&"min-h-36"),role:"presentation",children:[s.jsx("div",{ref:f,"aria-hidden":!0}),v]})}const Q={isDirty:!1,isSaving:!1,body:void 0,attachments:[]},A=J()(e=>({editorIsOpen:!1,setEditorIsOpen:t=>e(a=>({editorIsOpen:t})),ticketIsSaving:!1,setTicketIsSaving:t=>e(a=>({ticketIsSaving:t})),activeDraft:Q,updateActiveDraft:t=>e(a=>{var i;const r=!ye(t.body)||!!((i=t.attachments)!=null&&i.length);return{activeDraft:{...a.activeDraft,isDirty:r,...t}}}),discardActiveDraft:()=>e(()=>({activeDraft:Q}))}));function _(){return A.getState()}function ye(e){return e?e.trim()==="<p></p>"||!e.trim():!0}function ve({queryKey:e,defaultOrderDir:t,defaultOrderBy:a,queryParams:r},i,n=""){return i.orderBy||(i.orderBy=a),i.orderDir||(i.orderDir=t),[...e,i,n,r]}function je(e){var b,q,E,M;const{initialPage:t,endpoint:a,defaultOrderBy:r,defaultOrderDir:i,queryParams:n,paginate:c,transformResponse:p,willSortOrFilter:y=!1}=e,[m,h]=d.useState(""),[f,j]=d.useState({orderBy:r,orderDir:i}),x=ve(e,f,m),N=d.useRef(O(x)).current,u=he({placeholderData:y?W:void 0,queryKey:x,queryFn:({pageParam:l,signal:C})=>{const R={...n,perPage:(t==null?void 0:t.per_page)||(n==null?void 0:n.perPage),query:m,paginate:c,...f};return c==="cursor"?R.cursor=l:R.page=l||1,ke(a,R,p,C)},initialPageParam:c==="cursor"?"":1,getNextPageParam:l=>X(l.pagination)?"next_cursor"in l.pagination?l.pagination.next_cursor:l.pagination.current_page+1:null,initialData:()=>{if(!(!t||O(x)!==N))return{pageParams:[void 0,1],pages:[{pagination:t}]}}}),v=d.useMemo(()=>{var l;return((l=u.data)==null?void 0:l.pages.flatMap(C=>C.pagination.data))||[]},[(b=u.data)==null?void 0:b.pages]),g=(q=u.data)==null?void 0:q.pages[0].pagination,D=g&&"total"in g&&g.total?g.total:null;return{...u,items:v,totalItems:D,noResults:((M=(E=u.data)==null?void 0:E.pages)==null?void 0:M[0].pagination.data.length)===0,isReloading:u.isFetching&&!u.isFetchingNextPage&&u.isPlaceholderData,sortDescriptor:f,setSortDescriptor:j,searchQuery:m,setSearchQuery:h}}async function ke(e,t,a,r){return t.query&&await new Promise(i=>setTimeout(i,300)),S.get(e,{params:t,signal:t.query?r:void 0}).then(i=>a?a(i.data):i.data)}function Fe(e,t){return je({queryKey:["tickets",`${e}`,"replies"],endpoint:`tickets/${e}/replies`,initialPage:t})}function De(e,{absolute:t,tab:a}={}){a||(a="tickets");let r=`/agent/users/${e}/${a}`;return t&&(r=`${Z().settings.base_url}${r}`),r}function be(){const{data:e}=ee();return d.useCallback(()=>{e&&(e.draft&&_().updateActiveDraft({...e.draft,isDirty:!1}),_().setEditorIsOpen(!0))},[e])}function Pe({clearTicketCache:e=!0}={}){const{ticketId:t}=te(),{updateActiveDraft:a,discardActiveDraft:r}=A();return T({mutationFn:i=>(a({isSaving:!0}),Se(i)),onSuccess:async()=>{r(),e&&await P.invalidateQueries({queryKey:["tickets",`${t}`]})},onError:i=>F(i),onSettled:()=>a({isSaving:!1})})}function Se(e){return S.delete(`replies/${e.id}`).then(t=>t.data)}function we({draft:e}){const t=be();return s.jsxs(d.Fragment,{children:[s.jsx(w,{variant:"outline",size:"2xs",className:"ml-14",onClick:()=>t(),children:s.jsx(o,{message:"Edit"})}),s.jsx(Ne,{draft:e})]})}function Ne({draft:e}){return s.jsxs(se,{type:"modal",children:[s.jsx(w,{variant:"outline",size:"2xs",className:"ml-6",children:s.jsx(o,{message:"Discard"})}),s.jsx(Ce,{draft:e})]})}function Ce({draft:e}){const t=Pe(),{close:a}=ae();return s.jsx(re,{isDanger:!0,title:s.jsx(o,{message:"Discard draft"}),body:s.jsx(o,{message:"Are you sure you want to discard this draft?"}),confirm:s.jsx(o,{message:"Discard"}),onConfirm:()=>t.mutate({id:e.id},{onSuccess:a}),isLoading:t.isPending})}const Re={month:"short",day:"numeric",hour:"numeric",minute:"numeric"};function Ae({reply:e,isInitial:t,actions:a,attachments:r,className:i,ticketRequestType:n}){const c=d.useRef(null);return d.useEffect(()=>{c.current&&ie(c.current)},[]),s.jsxs("div",{className:k("flex items-start gap-20 border-x-2 border-t border-x-transparent py-24",e.type==="drafts"&&"border-l-primary",e.type==="notes"&&"border-l-warning bg-warning/6",i),children:[e.user&&s.jsx(ne,{to:De(e.user.id),className:"flex-shrink-0 max-md:hidden",target:"_blank",children:s.jsx(xe,{user:e.user,size:"w-50 h-50",circle:!0})}),s.jsxs("div",{className:"min-w-0 flex-auto",children:[s.jsx(Te,{reply:e,isInitial:t,actions:a}),s.jsx("div",{ref:c,className:"ticket-reply-body mr-24 text-sm",dangerouslySetInnerHTML:{__html:e.body}}),r]})]})}function Te({reply:e,isInitial:t,actions:a}){var i,n;const{user:r}=oe();return s.jsxs("div",{className:"mb-14 flex items-center",children:[s.jsx("div",{className:"font-medium",children:((i=e.user)==null?void 0:i.id)===(r==null?void 0:r.id)?s.jsx(o,{message:"You"}):(n=e.user)==null?void 0:n.display_name}),s.jsx("div",{className:"ml-4",children:s.jsx(qe,{reply:e,isInitial:t})}),s.jsx("div",{className:"ml-auto mr-4 flex-shrink-0 text-xs text-muted",children:s.jsx(ce,{date:e.created_at,options:Re})}),a]})}function qe({reply:e,isInitial:t}){switch(e.type){case"drafts":return s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"text-primary",children:s.jsx(o,{message:"created a draft"})}),s.jsx(we,{draft:e})]});case"notes":return s.jsx("span",{className:"text-warning",children:s.jsx(o,{message:"left a note"})});case"replies":return t?s.jsx("span",{className:"text-muted max-md:hidden",children:s.jsx(o,{message:"started the conversaion"})}):s.jsx("span",{className:"text-muted",children:s.jsx(o,{message:"replied"})})}}function Be({isLoading:e,onSubmit:t}){return s.jsx(w,{variant:"flat",color:"primary",radius:"rounded-none",disabled:e,onClick:()=>t==null?void 0:t(),children:s.jsx(o,{message:"Send reply"})})}function Ke(e){return T({mutationFn:t=>Ee(t),onSuccess:async()=>{await P.invalidateQueries({queryKey:["tickets"]}),ue(de("Ticket created"))},onError:t=>le(t,e)})}function Ee(e){return S.post("tickets",e).then(t=>t.data)}export{_e as I,Be as S,Oe as T,xe as U,A as a,Fe as b,Ae as c,be as d,je as e,Pe as f,De as g,Q as h,Ke as i,_ as t,Qe as u};
//# sourceMappingURL=use-create-ticket-15623dd6.js.map
