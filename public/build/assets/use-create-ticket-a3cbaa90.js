import{cS as $,cT as F,cU as H,cV as z,cW as U,O as Q,ak as A,v as j,r as u,bh as V,j as s,s as C,a5 as w,t as B,c as D,B as S,T as d,y as Y,F as G,G as W,b1 as X,aY as J,cX as M,Q as Z,au as ee,u as te,D as se,f as ae,ae as re,N as ie,z as ne,E as ce,al as L,a3 as oe,a4 as ue,a6 as de,m as le,av as fe}from"./main-e1cf0da5.js";import{k as me,y as he,C as xe}from"./reply-editor-6e29b1f9.js";var ge=class extends ${constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:F()},t)}getOptimisticResult(e){return e.behavior=F(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var y,h,x,m;const{state:a}=e,r=super.createResult(e,t),{isFetching:i,isRefetching:n}=r,c=i&&((h=(y=a.fetchMeta)==null?void 0:y.fetchMore)==null?void 0:h.direction)==="forward",o=i&&((m=(x=a.fetchMeta)==null?void 0:x.fetchMore)==null?void 0:m.direction)==="backward";return{...r,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:H(t,a.data),hasPreviousPage:z(t,a.data),isFetchingNextPage:c,isFetchingPreviousPage:o,isRefetching:n&&!c&&!o}}};function pe(e,t){return U(e,ge,t)}function $e(e){return Q({queryKey:["tickets",e],queryFn:()=>ye(e),placeholderData:A})}function ye(e){return j.get("tickets",{params:e}).then(t=>t.data)}function ve({user:e,...t}){var r;const{auth:a}=u.useContext(V);return s.jsx(me,{...t,label:e==null?void 0:e.display_name,src:e==null?void 0:e.avatar,link:(e==null?void 0:e.id)&&((r=a.getUserProfileLink)==null?void 0:r.call(a,e))})}function He(){return C({mutationFn:e=>je(e),onSuccess:async()=>{w.invalidateQueries({queryKey:["mailbox","sidenav-tags"]}),await w.invalidateQueries({queryKey:["tickets"]})},onError:e=>B(e)})}function je(e){return j.post("tickets/status/change",e).then(t=>t.data)}function ze({query:{isInitialLoading:e,fetchNextPage:t,isFetchingNextPage:a,hasNextPage:r},children:i,loaderMarginTop:n="mt-24",style:c,className:o,variant:y="infiniteScroll",loadMoreExtraContent:h,size:x="md"}){const m=u.useRef(null),k=a||e,[p,N]=u.useState(0),l=y==="loadMore"&&p<3?"loadMore":"infiniteScroll";u.useEffect(()=>{const g=m.current;if(!g||l==="loadMore")return;const b=new IntersectionObserver(([P])=>{P.isIntersecting&&r&&!k&&t()});return b.observe(g),()=>{b.unobserve(g)}},[t,r,k,l]);let v;return i?v=a?i:null:l==="loadMore"?v=!e&&r&&s.jsxs("div",{className:D("flex items-center gap-8",n),children:[h,s.jsx(S,{size:x==="md"?"sm":"xs",className:D(x==="sm"?"min-h-24 min-w-96":"min-h-36 min-w-112"),variant:"outline",color:"primary",onClick:()=>{t(),N(p+1)},disabled:k,children:p>=2&&!a?s.jsx(d,{message:"Load all"}):s.jsx(d,{message:"Show more"})})]}):v=s.jsx(Y,{children:a&&s.jsx(G.div,{className:D("flex justify-center w-full",n),...W,children:s.jsx(X,{size:x,isIndeterminate:!0,"aria-label":"loading"})})}),s.jsxs("div",{style:c,className:D("w-full",o,r&&"min-h-36"),role:"presentation",children:[s.jsx("div",{ref:m,"aria-hidden":!0}),v]})}const I={isDirty:!1,isSaving:!1,body:void 0,attachments:[]},K=J()(e=>({editorIsOpen:!1,setEditorIsOpen:t=>e(a=>({editorIsOpen:t})),ticketIsSaving:!1,setTicketIsSaving:t=>e(a=>({ticketIsSaving:t})),activeDraft:I,updateActiveDraft:t=>e(a=>{var i;const r=!ke(t.body)||!!((i=t.attachments)!=null&&i.length);return{activeDraft:{...a.activeDraft,isDirty:r,...t}}}),discardActiveDraft:()=>e(()=>({activeDraft:I}))}));function O(){return K.getState()}function ke(e){return e?e.trim()==="<p></p>"||!e.trim():!0}function De({queryKey:e,defaultOrderDir:t,defaultOrderBy:a,queryParams:r},i,n=""){return i.orderBy||(i.orderBy=a),i.orderDir||(i.orderDir=t),[...e,i,n,r]}function be(e){var P,R,_,E;const{initialPage:t,endpoint:a,defaultOrderBy:r,defaultOrderDir:i,queryParams:n,paginate:c,transformResponse:o,willSortOrFilter:y=!1}=e,[h,x]=u.useState(""),[m,k]=u.useState({orderBy:r,orderDir:i}),p=De(e,m,h),N=u.useRef(M(p)).current,l=pe({placeholderData:y?A:void 0,queryKey:p,queryFn:({pageParam:f,signal:T})=>{const q={...n,perPage:(t==null?void 0:t.per_page)||(n==null?void 0:n.perPage),query:h,paginate:c,...m};return c==="cursor"?q.cursor=f:q.page=f||1,Pe(a,q,o,T)},initialPageParam:c==="cursor"?"":1,getNextPageParam:f=>he(f.pagination)?"next_cursor"in f.pagination?f.pagination.next_cursor:f.pagination.current_page+1:null,initialData:()=>{if(!(!t||M(p)!==N))return{pageParams:[void 0,1],pages:[{pagination:t}]}}}),v=u.useMemo(()=>{var f;return((f=l.data)==null?void 0:f.pages.flatMap(T=>T.pagination.data))||[]},[(P=l.data)==null?void 0:P.pages]),g=(R=l.data)==null?void 0:R.pages[0].pagination,b=g&&"total"in g&&g.total?g.total:null;return{...l,items:v,totalItems:b,noResults:((E=(_=l.data)==null?void 0:_.pages)==null?void 0:E[0].pagination.data.length)===0,isReloading:l.isFetching&&!l.isFetchingNextPage&&l.isPlaceholderData,sortDescriptor:m,setSortDescriptor:k,searchQuery:h,setSearchQuery:x}}async function Pe(e,t,a,r){return t.query&&await new Promise(i=>setTimeout(i,300)),j.get(e,{params:t,signal:t.query?r:void 0}).then(i=>a?a(i.data):i.data)}function Ue(e,t){return be({queryKey:["tickets",`${e}`,"replies"],endpoint:`tickets/${e}/replies`,initialPage:t})}function we(e,{absolute:t,tab:a}={}){a||(a="tickets");let r=`/agent/users/${e}/${a}`;return t&&(r=`${Z().settings.base_url}${r}`),r}function Se(){const{data:e}=ee();return u.useCallback(()=>{e&&(e.draft&&O().updateActiveDraft({...e.draft,isDirty:!1}),O().setEditorIsOpen(!0))},[e])}function Ne({clearTicketCache:e=!0}={}){const{ticketId:t}=te(),{updateActiveDraft:a,discardActiveDraft:r}=K();return C({mutationFn:i=>(a({isSaving:!0}),Te(i)),onSuccess:async()=>{r(),e&&await w.invalidateQueries({queryKey:["tickets",`${t}`]})},onError:i=>B(i),onSettled:()=>a({isSaving:!1})})}function Te(e){return j.delete(`replies/${e.id}`).then(t=>t.data)}function qe({draft:e}){const t=Se();return s.jsxs(u.Fragment,{children:[s.jsx(S,{variant:"outline",size:"2xs",className:"ml-14",onClick:()=>t(),children:s.jsx(d,{message:"Edit"})}),s.jsx(Ce,{draft:e})]})}function Ce({draft:e}){return s.jsxs(se,{type:"modal",children:[s.jsx(S,{variant:"outline",size:"2xs",className:"ml-6",children:s.jsx(d,{message:"Discard"})}),s.jsx(Re,{draft:e})]})}function Re({draft:e}){const t=Ne(),{close:a}=ae();return s.jsx(re,{isDanger:!0,title:s.jsx(d,{message:"Discard draft"}),body:s.jsx(d,{message:"Are you sure you want to discard this draft?"}),confirm:s.jsx(d,{message:"Discard"}),onConfirm:()=>t.mutate({id:e.id},{onSuccess:a}),isLoading:t.isPending})}const _e={month:"short",day:"numeric",hour:"numeric",minute:"numeric"};function Ve({reply:e,isInitial:t,actions:a,attachments:r,className:i,ticketRequestType:n}){const c=u.useRef(null);return u.useEffect(()=>{c.current&&ie(c.current)},[]),s.jsxs("div",{className:D("flex items-start gap-20 border-x-2 border-t border-x-transparent py-24",e.type==="drafts"&&"border-l-primary",e.type==="notes"&&"border-l-warning bg-warning/6",i),children:[e.user&&s.jsx(ne,{to:we(e.user.id),className:"flex-shrink-0 max-md:hidden",target:"_blank",children:s.jsx(ve,{user:e.user,size:"w-50 h-50",circle:!0})}),s.jsxs("div",{className:"min-w-0 flex-auto",children:[s.jsx(Ee,{reply:e,isInitial:t,actions:a}),s.jsx("div",{ref:c,className:"ticket-reply-body mr-24 text-sm",dangerouslySetInnerHTML:{__html:e.body}}),r]})]})}function Ee({reply:e,isInitial:t,actions:a}){var i,n;const{user:r}=ce();return s.jsxs("div",{className:"mb-14 flex items-center",children:[s.jsx("div",{className:"font-medium",children:((i=e.user)==null?void 0:i.id)===(r==null?void 0:r.id)?s.jsx(d,{message:"You"}):(n=e.user)==null?void 0:n.display_name}),s.jsx("div",{className:"ml-4",children:s.jsx(Fe,{reply:e,isInitial:t})}),s.jsx("div",{className:"ml-auto mr-4 flex-shrink-0 text-xs text-muted",children:s.jsx(L,{date:e.created_at,options:_e})}),a]})}function Fe({reply:e,isInitial:t}){switch(e.type){case"drafts":return s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"text-primary",children:s.jsx(d,{message:"created a draft"})}),s.jsx(qe,{draft:e})]});case"notes":return s.jsx("span",{className:"text-warning",children:s.jsx(d,{message:"left a note"})});case"replies":return t?s.jsx("span",{className:"text-muted max-md:hidden",children:s.jsx(d,{message:"started the conversaion"})}):s.jsx("span",{className:"text-muted",children:s.jsx(d,{message:"replied"})})}}function Me(e){return Q({queryKey:["new-ticket-request-type"],queryFn:()=>Ie(e)})}function Ie(e){return j.get(`ticket-request-type/${e}`).then(t=>t.data)}const Oe="relative flex flex-shrink-0 items-center justify-center gap-10 overflow-hidden whitespace-nowrap outline-none after:pointer-events-none rounded-full bg-chip text-main pl-8 h-20 text-xs font-medium hover:after:bg-black/5 focus:after:bg-black/10";function Qe({ticketRequestType:e}){const t=Me(e);return s.jsx("div",{className:Oe,children:t&&t.data&&t.data.ticket_request_type.display_name})}const Ae={month:"short",day:"numeric"};function Ye({ticket:e,actions:t,children:a}){return s.jsx(u.Fragment,{children:s.jsxs("div",{className:"flex items-start gap-12 px-20 py-14 max-md:flex-col md:items-center",children:[s.jsxs("div",{className:"flex items-center gap-8",children:[s.jsx("h1",{className:"text-2xl",children:e.subject}),s.jsx(Qe,{ticketRequestType:e.ticket_request_type})]}),a,s.jsx("div",{className:"mr-24 max-md:hidden"}),s.jsxs("div",{className:"whitespace-nowrap text-muted md:ml-auto",children:[s.jsx(oe,{date:e.created_at})," (",s.jsx(L,{date:e.created_at,options:Ae}),")"]}),t]})})}function Ge({ticket:e,onRemoveTag:t,tagType:a,size:r="xs",...i}){var n,c;return(n=e.tags)!=null&&n.length?s.jsx(xe,{...i,size:r,selectable:!!t,children:(c=e.tags)==null?void 0:c.filter(o=>o.type!=="status"&&(!a||o.type===a)).map(o=>s.jsx(ue,{onRemove:t?()=>t(o):void 0,children:o.display_name},o.id))}):null}function We({isLoading:e,onSubmit:t}){return s.jsx(S,{variant:"flat",color:"primary",radius:"rounded-none",disabled:e,onClick:()=>t==null?void 0:t(),children:s.jsx(d,{message:"Send reply"})})}function Xe(e){return C({mutationFn:t=>Be(t),onSuccess:async()=>{await w.invalidateQueries({queryKey:["tickets"]}),de(le("Ticket created"))},onError:t=>fe(t,e)})}function Be(e){return j.post("tickets",e).then(t=>t.data)}export{ze as I,We as S,Ve as T,ve as U,$e as a,K as b,Ue as c,Se as d,Ye as e,Ge as f,be as g,we as h,Ne as i,I as j,Xe as k,Ae as l,Qe as m,O as t,He as u};
//# sourceMappingURL=use-create-ticket-a3cbaa90.js.map
